<!doctype html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ç›‘æ§ä»ªè¡¨ç›˜ - æ™ºæ…§æœå›­</title>
    <!-- å›¾æ ‡ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ</text></svg>">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* 1. æ»šåŠ¨æ¡ä¼˜åŒ– */
        ::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; background-color: #f4f6f9; }

        /* 2. æŒ‰é’®çŠ¶æ€ */
        .btn-active-green { background-color: #198754 !important; color: white !important; border-color: #198754 !important; }
        .btn-active-red { background-color: #dc3545 !important; color: white !important; border-color: #dc3545 !important; }
        .btn-inactive { background-color: #fff !important; color: #6c757d !important; border-color: #dee2e6 !important; }

        /* 3. èŠå¤©çª—å£ */
        .chat-window {
            height: 300px; /* å›ºå®šé«˜åº¦ï¼Œæˆ–è€…ä½ å¯ä»¥å»æ‰è¿™ä¸ªç”± flex æ§åˆ¶ï¼Œä½†å›ºå®šé«˜åº¦åœ¨ç§»åŠ¨ç«¯ä½“éªŒå¥½ */
            overflow-y: auto;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
        }
        .chat-bubble { padding: 10px 14px; border-radius: 15px; margin-bottom: 10px; max-width: 85%; word-wrap: break-word; font-size: 0.95rem; line-height: 1.6; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .chat-user { background-color: #0d6efd; color: white; margin-left: auto; border-bottom-right-radius: 2px; }
        .chat-bot { background-color: #f8f9fa; color: #333; margin-right: auto; border-bottom-left-radius: 2px; border: 1px solid #e9ecef; }
        .chat-system { font-size: 0.8rem; color: #adb5bd; text-align: center; margin: 8px 0; }

        /* Markdown æ ·å¼ */
        .chat-bot h5 { margin-top: 8px; font-weight: bold; font-size: 1rem; color: #0d6efd; }
        .chat-bot strong { color: #d63384; }

        /* 4. å¡ç‰‡æ ·å¼ */
        .card { border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border-radius: 12px; transition: transform 0.2s; }
        .sensor-card:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.08); }
    </style>
</head>
<body>

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm mb-4">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold d-flex align-items-center" href="/">
                <span style="font-size: 1.5rem; margin-right: 8px;">ğŸ</span>
                æ™ºæ…§æœå›­ç®¡ç†ç³»ç»Ÿ
            </a>
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav ms-auto align-items-center pt-2 pt-lg-0">
                    <li class="nav-item me-3 text-white">
                        <small class="opacity-75">ç”¨æˆ·:</small> <strong>{{ username }}</strong>
                        {% if role == 'admin' %}
                            <span class="badge bg-warning text-dark ms-1">ç®¡ç†å‘˜</span>
                        {% else %}
                            <span class="badge bg-light text-primary ms-1">ç”¨æˆ·</span>
                        {% endif %}
                    </li>
                    <li class="nav-item">
                        <a href="/logout" class="btn btn-sm btn-light text-primary fw-bold rounded-pill px-3 mt-2 mt-lg-0">é€€å‡ºç™»å½•</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="container-fluid px-3 px-lg-5">

        <!-- æ ‡é¢˜å¤´ -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
            <div class="mb-2 mb-md-0">
                <h3 class="fw-bold text-dark mb-0">ç›‘æ§ä»ªè¡¨ç›˜</h3>
                <small class="text-muted">Real-time Monitoring & AI Assistant</small>
            </div>
            <div>
                <span id="llm-status" class="badge bg-secondary rounded-pill px-3 py-2">è¿æ¥æ¨¡å‹ä¸­...</span>
            </div>
        </div>

        <!-- 1. ä¼ æ„Ÿå™¨æ•°æ® (è‡ªé€‚åº”ï¼šæ‰‹æœºä¸€è¡Œ2ä¸ªï¼Œç”µè„‘ä¸€è¡Œ4ä¸ª) -->
        <!-- align-items-stretch ä¿è¯å¡ç‰‡é«˜åº¦ä¸€è‡´ -->
        <div class="row g-3 mb-4 align-items-stretch">
            <div class="col-6 col-md-3">
                <div class="card sensor-card p-3 text-center h-100">
                    <div class="text-muted small mb-2">ğŸŒ¡ï¸ æ¸©åº¦</div>
                    <h3 id="val-temp" class="text-primary fw-bold mb-0">--</h3>
                    <small class="text-muted">Â°C</small>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card sensor-card p-3 text-center h-100">
                    <div class="text-muted small mb-2">ğŸ’§ æ¹¿åº¦</div>
                    <h3 id="val-hum" class="text-info fw-bold mb-0">--</h3>
                    <small class="text-muted">%</small>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card sensor-card p-3 text-center h-100">
                    <div class="text-muted small mb-2">â˜€ï¸ å…‰ç…§</div>
                    <h3 id="val-light" class="text-warning fw-bold mb-0">--</h3>
                    <small class="text-muted">Lx</small>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card sensor-card p-3 text-center h-100">
                    <div class="text-muted small mb-2">ğŸŒ¤ï¸ å¤©æ°”</div>
                    <h4 id="val-weather" class="fw-bold mb-0 mt-1">--</h4>
                    <small class="text-muted">å®æ—¶</small>
                </div>
            </div>
        </div>

        <!-- 2. æ ¸å¿ƒå†…å®¹åŒº (å›¾è¡¨ + AI/æ§åˆ¶) -->
        <!-- é‡ç‚¹ï¼šalign-items-stretch å¼ºåˆ¶å·¦å³ä¸¤åˆ—é«˜åº¦å¯¹é½ -->
        <div class="row g-3 align-items-stretch mb-5">

            <!-- å·¦ä¾§ï¼šå›¾è¡¨ -->
            <div class="col-lg-8 col-12">
                <!-- h-100 è®©å¡ç‰‡æ’‘æ»¡åˆ—é«˜ -->
                <div class="card p-3 h-100">
                    <h5 class="card-title mb-0 fw-bold">ğŸ“ˆ è¶‹åŠ¿é¢„æµ‹ (æœªæ¥30åˆ†é’Ÿ)</h5>
                    <div style="position: relative; width: 100%; height: 100%; min-height: 400px; display: flex; flex-direction: column;">
                        <!-- flex-grow è®© canvas å®¹å™¨è‡ªåŠ¨å¡«æ»¡å¡ç‰‡å‰©ä½™ç©ºé—´ -->
                        <div style="flex-grow: 1; position: relative;">
                            <canvas id="tempChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šAI + æ§åˆ¶ -->
            <!-- é‡ç‚¹ï¼šd-flex flex-column gap-3 è®©å†…éƒ¨å¡ç‰‡å‚ç›´æ’åˆ—å¹¶è‡ªåŠ¨å¡«å…… -->
            <div class="col-lg-4 col-12 d-flex flex-column gap-3">

                <!-- 1. AI é¡¾é—® (flex-grow-1 è®©å®ƒè‡ªåŠ¨æ‹‰ä¼¸ï¼Œå¡«è¡¥é«˜åº¦å·®) -->
                <div class="card p-3 flex-grow-1">
                    <h5 class="card-title fw-bold mb-3">ğŸ¤– æ™ºæ…§å†œæŠ€é¡¾é—®</h5>
                    <div id="ai-advice" class="alert alert-success py-2 px-3 mb-2 small border-0 bg-opacity-10 bg-success text-success">
                        <span class="spinner-border spinner-border-sm"></span> æ­£åœ¨ç”Ÿæˆå»ºè®®...
                    </div>

                    <!-- èŠå¤©çª—å£ï¼šä½¿ç”¨ flex-grow è‡ªåŠ¨æ’‘å¼€å†…éƒ¨é«˜åº¦ -->
                    <div id="chat-window" class="chat-window mb-2" style="flex-grow: 1; min-height: 200px;">
                        <div class="chat-system">å·²è¿æ¥ DeepSeek å†œä¸šå¤§æ¨¡å‹</div>
                    </div>

                    <div class="input-group">
                        <input id="chat-input" class="form-control border-end-0" placeholder="é—®ç‚¹ä»€ä¹ˆ..." onkeypress="handleEnter(event)">
                        <button id="btn-send" class="btn btn-primary px-4" onclick="sendChat()">å‘é€</button>
                    </div>
                </div>

                <!-- 2. è¿œç¨‹æ§åˆ¶ (å›ºå®šé«˜åº¦ï¼Œæ²‰åœ¨åº•éƒ¨) -->
                {% if role == 'admin' %}
                <!-- ç®¡ç†å‘˜è§†è§’ -->
                <div class="card p-3 border-top border-4 border-primary">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0 fw-bold">ğŸ® è¿œç¨‹æ§åˆ¶</h5>
                        <a href="/admin/users" class="text-decoration-none small badge bg-light text-muted">ç®¡ç†åå° &rarr;</a>
                    </div>

                    <div class="row g-3">
                        <div class="col-6">
                            <div class="p-2 border rounded bg-light text-center">
                                <div class="small text-muted mb-2">çŒæº‰ç³»ç»Ÿ</div>
                                <div class="btn-group w-100 shadow-sm" role="group">
                                    <button id="btn-water-on" class="btn btn-sm btn-inactive" onclick="sendControl('çŒæº‰ç³»ç»Ÿ', 1)">å¼€</button>
                                    <button id="btn-water-off" class="btn btn-sm btn-active-red" onclick="sendControl('çŒæº‰ç³»ç»Ÿ', 0)">å…³</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 border rounded bg-light text-center">
                                <div class="small text-muted mb-2">é®é˜³è®¾æ–½</div>
                                <div class="btn-group w-100 shadow-sm" role="group">
                                    <button id="btn-fan-on" class="btn btn-sm btn-inactive" onclick="sendControl('é®é˜³è®¾æ–½', 1)">å¼€</button>
                                    <button id="btn-fan-off" class="btn btn-sm btn-active-red" onclick="sendControl('é®é˜³è®¾æ–½', 0)">å…³</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% else %}
                <!-- æ™®é€šç”¨æˆ·è§†è§’ï¼šæƒé™é”å®šå¡ç‰‡ -->
                <div class="card p-4 text-center d-flex flex-column justify-content-center align-items-center" style="background-color: #f8f9fa;">
                    <div style="font-size: 2.5rem; margin-bottom: 10px; opacity: 0.3;">ğŸ”’</div>
                    <h5 class="text-muted fw-bold mb-1">æ§åˆ¶æƒé™å·²é”å®š</h5>
                    <p class="text-muted small mb-0">
                        æ‚¨å½“å‰çš„èº«ä»½ä¸º <span class="badge bg-secondary">æ™®é€šç”¨æˆ·</span><br>
                        ä¸ºä¿éšœè®¾æ–½å®‰å…¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ“ä½œè®¾å¤‡ã€‚
                    </p>
                </div>
                {% endif %}

            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- æ ¸å¿ƒé€»è¾‘ -->
    <script>
        let myChart = null;

        document.addEventListener('DOMContentLoaded', function () {
            initChart();
            setInterval(fetchData, 2000);
            setInterval(fetchAdvice, 10000);
            fetchData();
            fetchAdvice();
            fetchLLMStatus();
        });

        // --- 1. å›¾è¡¨åˆå§‹åŒ– ---
        function initChart() {
            const ctx = document.getElementById('tempChart').getContext('2d');
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'å†å²æ¸©åº¦', data: [], borderColor: '#0d6efd', backgroundColor: 'rgba(13, 110, 253, 0.05)', borderWidth: 2, pointRadius: 2, fill: true, tension: 0.4 },
                        { label: 'é¢„æµ‹æ¸©åº¦', data: [], borderColor: '#dc3545', borderDash: [5, 5], borderWidth: 2, pointRadius: 0, fill: false, tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', align: 'end' } },
                    interaction: { mode: 'index', intersect: false },
                    scales: { y: { beginAtZero: false, grid: { borderDash: [2, 2] } }, x: { grid: { display: false } } }
                }
            });
        }

        // --- 2. æ•°æ®åˆ·æ–° ---
        function fetchData() {
            fetch('/api/data').then(r => r.json()).then(data => {
                document.getElementById('val-temp').innerText = (data.current?.temp ?? 0);
                document.getElementById('val-hum').innerText = (data.current?.hum ?? 0);
                document.getElementById('val-light').innerText = (data.current?.light ?? 0);

                const w = data.weather || {};
                const weatherEl = document.getElementById('val-weather');
                if (w && (w.desc || w.category)) {
                    let iconHtml = w.emoji || 'ğŸŒ¤ï¸';
                    if (w.icon) iconHtml = `<img src="https://openweathermap.org/img/wn/${w.icon}.png" height="30">`;
                    weatherEl.innerHTML = `${iconHtml} ${w.desc || w.category}`;
                } else { weatherEl.innerText = 'æ™´'; }

                if (myChart) {
                    const histLen = data.history_temp ? data.history_temp.length : 0;
                    const labels = data.history_time || [];
                    const futureLabels = Array.from({ length: 30 }, (_, i) => '+' + (i + 1) + 'm');
                    myChart.data.labels = labels.concat(futureLabels);
                    myChart.data.datasets[0].data = data.history_temp || [];
                    const nullPad = new Array(histLen).fill(null);
                    if (histLen > 0) nullPad[histLen - 1] = data.history_temp[histLen - 1];
                    myChart.data.datasets[1].data = nullPad.concat((data.prediction && data.prediction.temp) || []);
                    myChart.update('none');
                }
            }).catch(console.error);
        }

        function fetchAdvice() { fetch('/api/advice').then(r => r.json()).then(d => { document.getElementById('ai-advice').innerText = d.advice || 'æ•°æ®é‡‡é›†ä¸­...'; }); }
        function fetchLLMStatus() { fetch('/api/llm_status').then(r => r.json()).then(s => { const el = document.getElementById('llm-status'); if (s.available) { el.innerHTML = `âœ… åœ¨çº¿: ${s.model}`; el.className = 'badge bg-success rounded-pill px-3 py-2'; } else { el.innerText = 'âš ï¸ æœªé…ç½® Key'; el.className = 'badge bg-danger rounded-pill px-3 py-2'; } }); }

        // --- 3. èŠå¤©åŠŸèƒ½ (Markdown + åŠ¨ç”») ---

        // è§£æç®€å• Markdown
        function parseMarkdown(text) {
            let html = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/###\s*(.*?)(?=\n|$)/g, '<h5>$1</h5>')
                .replace(/-\s+(.*?)(?=\n|$)/g, 'â€¢ $1<br>')
                .replace(/\n/g, '<br>');
            return html;
        }

        // æ‰“å­—æœºåŠ¨ç”»
        function typeWriter(element, text, speed = 20) {
            let i = 0;
            element.innerHTML = '';
            function type() {
                if (i < text.length) {
                    if (text.charAt(i) === '\n') {
                        element.innerHTML += '<br>';
                    } else {
                        element.innerHTML += text.charAt(i);
                    }
                    i++;
                    const w = document.getElementById('chat-window');
                    w.scrollTop = w.scrollHeight;
                    setTimeout(type, speed);
                } else {
                    element.innerHTML = parseMarkdown(text);
                }
            }
            type();
        }

        function appendChat(role, text, animate = false) {
            const w = document.getElementById('chat-window');
            const el = document.createElement('div');
            el.className = 'd-flex';
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${role === 'user' ? 'chat-user' : 'chat-bot'}`;

            el.appendChild(bubble);
            w.appendChild(el);

            if (role === 'bot' && animate) {
                typeWriter(bubble, text);
            } else {
                bubble.innerHTML = parseMarkdown(text);
            }
            w.scrollTop = w.scrollHeight;
        }

        window.sendChat = function () {
            const input = document.getElementById('chat-input');
            const btn = document.getElementById('btn-send');
            const msg = input.value.trim();
            if (!msg) return;

            appendChat('user', msg);
            input.value = '';
            input.disabled = true;
            btn.innerText = '...';
            btn.disabled = true;

            const w = document.getElementById('chat-window');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-system';
            loadingDiv.innerHTML = '<span class="spinner-grow spinner-grow-sm"></span> æ€è€ƒä¸­...';
            w.appendChild(loadingDiv);
            w.scrollTop = w.scrollHeight;

            fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: msg })
            })
            .then(r => r.json())
            .then(j => {
                w.removeChild(loadingDiv);
                const reply = j.reply || j.error || 'æ— å›å¤';
                appendChat('bot', reply, true);
            })
            .catch(() => {
                w.removeChild(loadingDiv);
                appendChat('bot', 'âŒ ç½‘ç»œé”™è¯¯', false);
            })
            .finally(() => {
                input.disabled = false;
                input.focus();
                btn.innerText = 'å‘é€';
                btn.disabled = false;
            });
        }
        window.handleEnter = function (e) { if (e.key === 'Enter') sendChat(); }

        // --- 4. è¿œç¨‹æ§åˆ¶ (é™é»˜å˜è‰²ç‰ˆ) ---
        window.sendControl = function (device, cmd) {
            let prefix = '';
            if (device === 'çŒæº‰ç³»ç»Ÿ') prefix = 'btn-water';
            if (device === 'é®é˜³è®¾æ–½') prefix = 'btn-fan';

            if(!prefix) return;

            const btnOn = document.getElementById(prefix + '-on');
            const btnOff = document.getElementById(prefix + '-off');

            fetch('/api/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device: device, command: cmd })
            })
            .then(r => r.json())
            .then(j => {
                if(j.status === 'success') {
                    if (cmd === 1) {
                        btnOn.className = 'btn btn-sm btn-active-green';
                        btnOff.className = 'btn btn-sm btn-inactive';
                    } else {
                        btnOn.className = 'btn btn-sm btn-inactive';
                        btnOff.className = 'btn btn-sm btn-active-red';
                    }
                    console.log(`âœ… æ“ä½œæˆåŠŸ: ${device} -> ${cmd}`);
                } else {
                    console.error(`âŒ åå°æ‹’ç»: ${j.msg}`);
                }
            })
            .catch(() => console.error('âŒ ç½‘ç»œé”™è¯¯'));
        }
    </script>
</body>
</html>